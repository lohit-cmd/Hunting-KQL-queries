// Lateral movement (SMB, RDP, remoting)
let lateral = DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemotePort in (3389, 902)
  or InitiatingProcessFileName in ("mstsc.exe", "psexec.exe", "winrs.exe")
| project DeviceId, DeviceName, AccountUpn = InitiatingProcessAccountUpn, LateralTime = Timestamp;
// vSphere CLI / PowerShell usage
let vsphere = DeviceProcessEvents
| where Timestamp > ago(7d)
| where ProcessCommandLine has_any("esxcli", "vim-cmd", "Connect-VIServer", "Get-VM", "New-VM")
| project DeviceId, AccountUpn = InitiatingProcessAccountUpn, VsphereTime = Timestamp;
// VM power/config actions
let vmOps = DeviceProcessEvents
| where Timestamp > ago(7d)
| where ProcessCommandLine has_any("Stop-VM", "Start-VM", "Set-VM", "Reconfigure-VM")
| project DeviceId, AccountUpn = InitiatingProcessAccountUpn, VmOpTime = Timestamp;
//  AD modifications via PowerShell
let adMods = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "powershell.exe"
  and ProcessCommandLine has_any("New-ADUser", "Set-ADUser")
| project DeviceId, AccountUpn = InitiatingProcessAccountUpn, ADTime = Timestamp;
// VMware file path or registry monitoring
let vmwareMon = union
    DeviceRegistryEvents
    | where Timestamp > ago(7d) and RegistryKey has_any(@"\\Program Files\\VMware", @"\\vCenter")
      | project DeviceId, AccountUpn = InitiatingProcessAccountUpn, VMTime = Timestamp,
               Source = "Registry";
    DeviceProcessEvents
    | where Timestamp > ago(7d) and InitiatingProcessFileName has_any("vmware-vim-cmd.exe", "vmware.exe")
      | project DeviceId, AccountUpn = InitiatingProcessAccountUpn, VMTime = Timestamp,
               Source = "Process";
// Security disablement via PowerShell
let secDisable = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "powershell.exe"
  and ProcessCommandLine has "Set-MpPreference -DisableRealtimeMonitoring"
| project DeviceId, AccountUpn = InitiatingProcessAccountUpn, SecTime = Timestamp;
//  Correlate within +/- 6 hours
lateral
| join kind=inner vsphere on DeviceId, AccountUpn
| where abs(datetime_diff('hour', VsphereTime, LateralTime)) <= 6
| join kind=inner vmOps on DeviceId, AccountUpn
| where abs(datetime_diff('hour', VmOpTime, LateralTime)) <= 6
| join kind=leftouter adMods on DeviceId, AccountUpn
| where abs(datetime_diff('hour', ADTime, LateralTime)) <= 6
| join kind=leftouter vmwareMon on DeviceId, AccountUpn
| where abs(datetime_diff('hour', VMTime, LateralTime)) <= 6
| join kind=leftouter secDisable on DeviceId, AccountUpn
| where abs(datetime_diff('hour', SecTime, LateralTime)) <= 6
| project
    DeviceName,
    AccountUpn,
    LateralTime,
    VsphereTime,
    VmOpTime,
    ADTime,
    VMTime,
    SecTime

