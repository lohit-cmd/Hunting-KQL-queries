  // 1. Detect suspicious child processes under w3wp.exe (post-exploit activity)
  let SuspiciousProc = DeviceProcessEvents
  | where InitiatingProcessFileName == "w3wp.exe"
  | where FileName in ("rundll32.exe","powershell.exe","cmd.exe")
  | where ProcessCommandLine has_any ("DownloadFile","Invoke-WebRequest",".aspx")
  | project ProcTime = bin(Timestamp,1s), DeviceId, ProcName = FileName, CmdLine = ProcessCommandLine;
  // 2. Detect dropped ASPX files (possible machine-key stealers)
  let SuspiciousDrop = DeviceFileEvents
  | where FileName endswith ".aspx"
    and (FileName contains "spinst" or FileName contains "install")
  | project DropTime = bin(Timestamp,1s), DeviceId, Dropped = strcat(FolderPath, "\\", FileName);
  // 3. Detect .aspx execution by w3wp.exe
  let NetTriggered = DeviceProcessEvents
  | where InitiatingProcessFileName == "w3wp.exe"
  | where ProcessCommandLine has ".aspx"
  | project NetTime = bin(Timestamp,1s), DeviceId, DeviceName;
  // 4. Correlate process + file events within Â±60 minutes
  NetTriggered
  | join kind=leftouter SuspiciousProc on DeviceId
  | join kind=leftouter SuspiciousDrop on DeviceId
  | extend DiffProc = datetime_diff("minute", ProcTime, NetTime),
          DiffDrop = datetime_diff("minute", DropTime, NetTime)
  | where (DiffProc between (-60 .. 60)) or (DiffDrop between (-60 .. 60))
  | project Time = NetTime, DeviceName, ProcName, CmdLine, Dropped

