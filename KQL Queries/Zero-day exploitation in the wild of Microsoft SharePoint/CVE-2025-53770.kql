// 1. Detect pre‑auth HTTP POSTs to SharePoint ToolPane endpoint
let PreAuth = DeviceNetworkEvents
| where ActionType == "HttpConnectionInspected"
| extend j = todynamic(AdditionalFields)
| where tostring(j.method) == "POST"
| where tostring(j.uri) contains "/_layouts/15/ToolPane.aspx?DisplayMode=Edit"
| where toint(j.request_body_len) > 2000
| project PreTime = bin(Timestamp, 1s), DeviceId, DeviceName, RemoteIP, URI = tostring(j.uri), BodyLen = toint(j.request_body_len);
// 2. Detect suspicious child processes under IIS w3wp.exe
let SuspiciousProc = DeviceProcessEvents
| where InitiatingProcessFileName == "w3wp.exe"
| where FileName in ("rundll32.exe","powershell.exe","cmd.exe")
| where ProcessCommandLine has_any ("DownloadFile","Invoke‑WebRequest",".aspx")
| project ProcTime = bin(Timestamp, 1s), DeviceId, ProcName = FileName, CmdLine = ProcessCommandLine;
// 3. Detect dropped ASPX files (possible payloads like spinstall0.aspx)
let SuspiciousDrop = DeviceFileEvents
| where FileName endswith ".aspx"
      and (FileName contains "spinst" or FileName contains "install")
| project DropTime = bin(Timestamp, 1s), DeviceId, Dropped = strcat(FolderPath, "\\", FileName);
// 4. Correlate events on same device within ±1 hour
PreAuth
| join kind=leftouter SuspiciousProc on DeviceId
| join kind=leftouter SuspiciousDrop on DeviceId
| extend DiffProc = datetime_diff("minute", ProcTime, PreTime),
         DiffDrop = datetime_diff("minute", DropTime, PreTime)
| where (DiffProc between (-60 .. 60)) or (DiffDrop between (-60 .. 60))
| project Time = PreTime,
          DeviceName, RemoteIP, URI, BodyLen,
          ProcName, CmdLine, Dropped

